# resilience_analysis

## Directory & code organisation

0_main/          - Contains scripts and functions that are called upon initialisation of other scripts to create the program environment and harmonise the plotting

1_create_df/     -  Contains scripts that extract, reformat & harmonise the input data (downloaded via /resilience_data_collection) in order to be combined into a single coherent dataframe

2_analysis/      - Contains scripts that create the random forest diversity-resilience models

3_create_figures - Contains plotting scripts for the dataframe, whilst /plotRF = plots the random forest outputs, /plotByBGR = biogeographical region plots

Further subdirectories:

functions - Contains helper functions for processing/plotting data

inputs    - Contains configuration parameters that can be varied or tuned for the plotting scripts; this includes the input/output names of files, in order to guide the program such that the main scripts do not need significant changing

## Running the code
To start the analysis from scratch, first ensure that the links match the downloaded input data (see resilience_data_collection/ or Detailed script descriptions: 1_create_df/ for the required format). These global links can be configured in 0_main/ and the local links to the datasets can be set in in  1_create_df/input/input_createDf_fromInput.R (see description below).
The analysis is started (via the conversion of the required input data to a common format) by running 1_create_df/1_createDf_fromInput.R . Subsequent scripts are run numerically (1, 2, ...) where required.
If the required data is already harmonised/formatted it is possible to start from one of the subsequent scripts (see detailed script descriptions below).


## Detailed script descriptions: 0_main/

This is the starting point for tailoring the program to the user's local environment. Create the local directory paths in input_initialise_R.R and ensure the that the paths exist and that the input data (generated via resilience_data_collection) is present.


### input/input_initialise_R.R
- Acts as a user input to initialise_R.R
- User must set the path links to the local directory structure
### initialise_R.R
- Sourced at the start of each program to set up the directory structure & links
### initialise_figs.R
- Standardised plotting variables (colors, label names, mapping extents, plotting themes)
### funtions/plotting_functions.R
- Contains common standardised plotting functions that are used elsewhere


## Detailed script descriptions: 1_create_df/

The aim of the scripts in this directory is to produce a harmonised dataframe of the input variables and features for the diversity-resilience model. These scripts take the input data downloaded and adjusted to a time series using the scripts in resilience_data_collection. The output of these scripts is a combined dataframe (df_comb, saved as 'df_all.RData') that covers the full time series (with a single value for each spatial pixel (x,y) across the time series) and that has each of these input variables in the format:

      x  |  y |  area | train_sample ... other identifying/useful variables
      kndvi_n | kndvi_mean | kndvi_lambda_xt | kndvi_lambda_variance | ... other kndvi timeseries related factors
      t2m_n | t2m_mean | t2m_CV | t2m_TAC | ... other ERA5 variables
      forestcover | socc30cm | Ndep | forestarea | topology_elevation_mean | ... other confounding factors
      Kurtosis | Shannon | Canopy_heigts_sd | ... other diversity metrics

where:
x/y are lon/lat coordinates ; area = pixel area ; n/count = number of entries ; mean refers to the multi-year mean ; xt/TAC refers to temporal autocorrelation ; CV refers to the coefficient of variation ; forestcover = the proportion of the pixel covered by forest ; forestarea the total forest area in a pixel ; socc30cm = soil organic carbon content in the 30cm layer ; Ndep = Nitrogen deposition.
A full list of variable descriptions can be found in the manuscript.

If the data is of this form, the user can jump to step 2_analysis/ to create the model or to 3_create_figures/plot_dataframe.R to plot the outputs.
Otherwise, the following scripts are used to convert the input data (generated by resilience_data_collection) to this combined dataframe format.
The input data should consist of either of
1) netcdf timeseries of data (of the format x,y,time,value). There should be two for each variable, one of the variable time series, the other containing the time series after deseasonalisation (ie the residuals/anomalies)
2) non-timeseries data (x,y,value) in either netcdf (.nc), geotif (.tif), or R dataframes (.RData)

### 1_createDf_fromInput.R
- Extracts the input data from the various file formats and creates a single dataframe, df_var.
- Time series inputs result in two output dataframe files (.RDATA), 'baseVar' for the time series values, and 'deseason' for the deseasonalised anomalies. Both format x | y | date | var_name [value]
- 'Static' [non-time-series] inputs result in output dataframe files (df_[var_name]_baseVar_full.RDATA) of form x | y | var_name/s [value]
### input/input_createDf_fromInput.R
- Configuration file that guides the createDf_fromInput.R
- The user must set the filepaths of each variable input to the filepath in their local directory

### 2_createDf_statistics.R
- This file applies only to the time series dataframes and for each variable calculates several key statistics that are used in the diversity-resilience model
- The input files must be of the form:  x | y | date | var_name 
- The output files are of the form:     x | y | mu | TAC | CoV ( |... other related stats for cross checking purposes)
- Several filters and functions are applied: a growing season masked based on the phenology ; an outlier removal to account for cloud cover in pixels ; a time series linear detrending ; calculation of mean and CoV and temporal autocorrelation and temporal variance of the deseasonalised time series
### input/input_createDf_statistics.R
- Config file that determines the I/O paths, the variables to run over, cloud cover threshold
- Determines which functions to run on time series data: outlier removal (and statistics collection/analysis), mask growing season, detrending

### 3_createDf_combine.R
- This script combines the separate dataframes of time series statistics (df_stats) and static variables (df_var) into a single dataframe (df_comb)
### input/input_createDf_combine.R
- Config file that sets the I/O paths & the variables to run over

### 4_createDf_selections.R
- This script places a series of data quality selections on the combined dataframe of all data inputs (df_comb)
- Outputs a harmonised dataframe that can be used in training the model (df_all.RData, df_comb)
- Applies selections: filter on GEDI/kNDVI counts, drop unnecessary columns, separate test/train set
- Creates dfs for cross checks: comparing differences between the different calculation methods of resilience metrics, compare GEDI/kNDVI count selections.
### input/input_createDf_selections.R
- Config script: sets I/O, sets filters & parameters, choose model features, treatment of removal of missing values, test/train dataset parameters


## Detailed script descriptions: 2_analysis/

The aim of these scripts is to build a model (e.g. Random Forest) that relates the resilience metric to the other model features. Different scripts are present to build a simple RF model, or to bootstrap multiple versions of the model (e.g. for uncertainty estimation). The scripts assume a dataframe, df_comb, containing, e.g.:

    Identification variables, e.g.: | x | y | train_sample [test or train pixel] | 
    Target variables, e.g.        : | kndvi_lambda_xt  | kndvi_lambda_variance   |
    Predictor variables, e.g.     : | t2m_mean | t2m_CV | t2m_TAC | (other environmental vars)
    Optional predictors, e.g.     : | FSDV/Kurtosis | FSDH/Canopy_heights_sd | other diversity metrics

The models predict the target variables (one per model) using the predictor variables and one of the optional predictors (per model). The identification variables determine if a given pixel is part of the test or training dataset, as well as location identifiers and other information that may be of use, but does not go into the input model.

### input/input_createRF_model.R 
- This script configures the parameters of the model and selects the relevant input/target/ID variables
### createRF_model_simple.R
- This script creates a single RF model for each FSD metric - resilience metric combination
- Also provides a simplified non-parallel version of the parameter tuning
### createRF_model_boot.R
- This script creates multiple different RF models in parallel, for each FSD metric - resilience metric combination
- The resulting models can be bootstrapped to give the uncertainty inherent to the model (this simplified version does not consider other uncertainties, e.g. in predictors)

### createPDP_fromModel.R
- This script takes as input the output of createRF_model_boot.R, a list of models and pdps (results), including potentially from multiple seeds.
- For each resilience-diversity metric combination, it merges the pdps in results (where already produced in  createRF_model_boot.R)
- If not already produced in previous step, it instead produces pdps for the selected variables
- These output pdps form the input for bootstrapped plots (taking the, e.g., mean, spread of the different bootstrapped models)
### input/input_createPDP_fromModel.R
- Config file for createPDP_fromModel.R


## Detailed script descriptions: 3_create_figures/

These scripts plot both the dataframe created in 1_createDf_fromInput.R and figures that enable the interpretation of the models created in 2_analysis/. As such they take as input either df_comb or the RF model.
 NOTE: The scripts here may assume that either a single RF model or a bootstrapped RF model is input (but it is simple to adapt to accomodate a bootstrapped dataset)

### input/input_plot_dataframe.R
- Configures minor plotting details, sets map/histogram limits and units on variables
- Note: can toggle between setting |abs| values of the restoration rates and inverse of kurtosis
- Also configures plot_dataframe_correlationMatrix.R

### input/input_plotRF.R
- Config script that sets parameters for all of the plotRF_...R scripts

### input/input_plotByBGR.R
- This script configures the input models and data for plotting the 1d partial dependence values at current and increased temperature by biogeographical (BGR) region
- It takes as input the RF models, the data used to train the models and the BGR dataframe

### plot_dataframe.R
- This script plots & maps each of a selected number of plots from the analysis dataframe (i.e. model inputs and predicted values) created in 1_create_df/

### plot_dataframe_correlationMatrix.R
- This script creates a correlation matrix of the different analysis dataframe variables

### plotRF_performance.R
- Plot test data performance metrics relating to the RF model
- Create a figure & dataframe of Observed vs Modelled data for each RF model including optional statistics

### plotRF_importance.R
- Plot a figure showing the relative importance of features in the RF model

### plotRF_partialPlot_createDF.R
- Create the dataframes for both 1D and 2D partial plots from the rf.models
- Runs a simple plotting of the partial plots

### plotRF_partialPlot_plotDF.R
- Plots the dataframes in a more formalised way for comparison between metrics

### plotRF_partialPlot_plotDF_2d.R
- Produce the 2D partial figures

### plotRF_partialPlot_boot.R
- Script uses the df_pdp_all dataframes containing the bootstrapped partial dependence values (pdp_i) previously produced via createPDP_fromModel.R
- The mean and uncertainty bounds (e.g. via s.d. or 95% percentile) are calculated for each combination of metrics
- The diversity-resilience figures with uncertainty bands are plotted
- A diversity-resilience figure showing multiple diversity metrics is plotted, whereby the diversity metric is scaled to represent the range (e.g. 95%) of diversity observed in the training dataset.

### plotRF_createICE.R
- Create a dataframe containing the Individual Conditional Expectation (ICE) values for each pixel
- Also takes the derivative of the ICE curves at each pixel's value (giving the direction of diversity-resilience relationship
- Outputs a dataframe containing the two
- NOTE: the computation takes a while and can run to a lot of RAM (therefore be split into chunks) so it is not recommended to run over multiple diverstiy & resilience metrics at a time

### plotRF_createICE_plotICE.R
- Take the df_dice dataframes containing the derivatie of the ICE curve at each point for a given resilience-diversity metric combination
- Plot the derivative in map form

### plotByBGR_createPDP_byBGR_bs.R
- The script creates the dataframes containing the bootstrapped partial dependence values for each combination on metrics, generated using dataframes with the current and the increased (+1°C) temperature and by biogeographical (BGR) region
- It takes as input the BGR dataframe and it merges the BGR of interest
- It takes as input the list of RF models from multiple seeds and the data used to train the models

### plotByBGR_plotPDP_byBGR_bs.R
- This script uses the output dataframes of plotByBGR_createPDP_byBGR_bs.R containing the bootstrapped partial dependence values by BGR and under current and increased temperature
- It merges the boostrapped partial dependence values and the mean and uncertainty bounds are calculated for each combination of metrics, each BGR and each temperature value
- It plots for each combination of metrics, and for each BGR, the 1d partial dependence plot (PDP) under current (solid) and increased (dashed) temperature with confidence interval

### plotByBGR_map.R
- This script creates a map showing the biogeographical regions used for the analysis 

